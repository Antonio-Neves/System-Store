{% extends 'store/base.html' %}

{% block title %}New Sale - Store Management{% endblock %}

{% block content %}
<div class="mb-4">
    <h2><i class="bi bi-cart-plus"></i> New Sale</h2>
</div>

<form method="post" id="saleForm">
    {% csrf_token %}

    <div class="row">
        <!-- Sale Items -->
        <div class="col-md-8 mb-4">
            <div class="card">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Sale Items</h5>
                </div>
                <div class="card-body">
                    <div id="items-container">
                        <!-- Items will be added here -->
                    </div>

                    <button type="button" class="btn btn-outline-primary" onclick="addItem()">
                        <i class="bi bi-plus-circle"></i> Add Product
                    </button>
                </div>
            </div>
        </div>

        <!-- Sale Info -->
        <div class="col-md-4 mb-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Sale Information</h5>
                </div>
                <div class="card-body">
                    <!-- Customer -->
                    <div class="mb-3">
                        <label class="form-label">Customer (Optional)</label>
                        <select name="customer" class="form-select">
                            <option value="">Walk-in Customer</option>
                            {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label class="form-label">Payment Method</label>
                        <select name="payment_method" class="form-select" required>
                            {% for value, label in payment_methods %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Discount -->
                    <div class="mb-3">
                        <label class="form-label">Discount</label>
                        <input type="number"
                               name="discount"
                               class="form-control"
                               step="0.01"
                               value="0"
                               id="discount"
                               onchange="calculateTotal()">
                    </div>

                    <hr>

                    <!-- Total -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Subtotal:</span>
                            <strong id="subtotal">R$ 0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Discount:</span>
                            <strong id="discount-display">R$ 0.00</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-3">
                            <h5>Total:</h5>
                            <h5 id="total" class="text-success">R$ 0.00</h5>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100 btn-lg">
                        <i class="bi bi-check-circle"></i> Complete Sale
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary w-100 mt-2">
                        Cancel
                    </a>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- Item Template (hidden) -->
<template id="item-template">
    <div class="row mb-3 item-row">
        <div class="col-md-6">
            <select name="product_id" class="form-select" onchange="updatePrice(this)" required>
                <option value="">Select Product</option>
                {% for product in products %}
                    <option value="{{ product.id }}"
                            data-price="{{ product.price }}"
                            data-stock="{{ product.stock }}">
                        {{ product.name }} - R$ {{ product.price|floatformat:2 }} (Stock: {{ product.stock }})
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <input type="number"
                   name="quantity"
                   class="form-control"
                   placeholder="Qty"
                   min="1"
                   value="1"
                   onchange="calculateTotal()"
                   required>
        </div>
        <div class="col-md-2">
            <input type="text"
                   class="form-control item-price"
                   placeholder="Price"
                   readonly>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-danger" onclick="removeItem(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
</template>

{% endblock %}

{% block extra_js %}
<script>
    let itemCount = 0;

    // Add initial item on page load
    window.onload = function() {
        addItem();
    }

    function addItem() {
        const template = document.getElementById('item-template');
        const clone = template.content.cloneNode(true);
        document.getElementById('items-container').appendChild(clone);
        itemCount++;
    }

    function removeItem(button) {
        if (itemCount > 1) {
            button.closest('.item-row').remove();
            itemCount--;
            calculateTotal();
        } else {
            alert('At least one item is required!');
        }
    }

    function updatePrice(select) {
        const row = select.closest('.item-row');
        const option = select.options[select.selectedIndex];
        const price = option.dataset.price;
        const stock = option.dataset.stock;

        row.querySelector('.item-price').value = 'R$ ' + parseFloat(price).toFixed(2);
        row.querySelector('input[name="quantity"]').max = stock;

        calculateTotal();
    }

    function calculateTotal() {
        let subtotal = 0;

        document.querySelectorAll('.item-row').forEach(row => {
            const select = row.querySelector('select[name="product_id"]');
            const quantity = parseFloat(row.querySelector('input[name="quantity"]').value) || 0;

            if (select.value) {
                const option = select.options[select.selectedIndex];
                const price = parseFloat(option.dataset.price) || 0;
                subtotal += price * quantity;
            }
        });

        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const total = subtotal - discount;

        document.getElementById('subtotal').textContent = 'R$ ' + subtotal.toFixed(2);
        document.getElementById('discount-display').textContent = 'R$ ' + discount.toFixed(2);
        document.getElementById('total').textContent = 'R$ ' + Math.max(0, total).toFixed(2);
    }

    // Validate form before submit
    document.getElementById('saleForm').onsubmit = function(e) {
        const rows = document.querySelectorAll('.item-row');
        let hasItems = false;

        rows.forEach(row => {
            const select = row.querySelector('select[name="product_id"]');
            if (select.value) {
                hasItems = true;
            }
        });

        if (!hasItems) {
            e.preventDefault();
            alert('Please add at least one product!');
            return false;
        }

        return true;
    }
</script>
{% endblock %}
